name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SMOKE_AUTH_BOOTSTRAP_URL: ${{ secrets.SMOKE_AUTH_BOOTSTRAP_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.27.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Typecheck
        run: pnpm -s typecheck
      - name: Lint
        run: pnpm -s lint
      - name: Check cockpit polling guardrail
        run: bash scripts/check-cockpit-polling.sh
      - name: Check Never-500 API invariant
        run: bash scripts/check-never-500.sh
      - name: Build
        run: pnpm -s build:ci
        env:
          NEXT_TELEMETRY_DISABLED: "1"
          NODE_OPTIONS: "--max-old-space-size=8192"
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: placeholder
          CLERK_SECRET_KEY: sk_test_placeholder
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder
          OPENAI_API_KEY: sk-placeholder
      - name: Install Playwright browsers
        run: pnpm -s e2e:install
      - name: E2E Smoke (public)
        run: pnpm -s e2e:smoke:public
        env:
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: placeholder
          CLERK_SECRET_KEY: sk_test_placeholder
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder
          OPENAI_API_KEY: sk-placeholder
          SMOKE_AUTH_BOOTSTRAP_URL: ${{ secrets.SMOKE_AUTH_BOOTSTRAP_URL }}
      - name: E2E Smoke (authed)
        if: env.SMOKE_AUTH_BOOTSTRAP_URL != ''
        run: pnpm -s e2e:smoke:authed
        env:
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: placeholder
          CLERK_SECRET_KEY: sk_test_placeholder
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_placeholder
          OPENAI_API_KEY: sk-placeholder
          SMOKE_AUTH_BOOTSTRAP_URL: ${{ secrets.SMOKE_AUTH_BOOTSTRAP_URL }}
      - name: Upload Playwright artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            playwright-report/
            test-results/
          if-no-files-found: warn
      - name: Upload build diagnostics (.ci)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-diagnostics
          path: .ci/
          if-no-files-found: warn
